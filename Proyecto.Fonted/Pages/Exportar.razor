@page "/exportar"
@inject NavigationManager NavigationManager

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Documentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="bg-light">
    <div class="container py-5">
        <h2 class="mb-4 text-center">Gestión de Documentos</h2>

        <div class="row g-4 justify-content-center">
            <!-- Tarjeta Investigaciones -->
            <div class="col-md-3">
                <div class="categoria-card">
                    <h5 class="card-title">
                        <i class="bi bi-journal-bookmark-fill"></i> Investigaciones
                    </h5>
                    <button class="btn" data-bs-toggle="modal" data-bs-target="#modalInvestigaciones">Ver</button>
                </div>
            </div>

            <!-- Tarjeta Obras -->
            <div class="col-md-3">
                <div class="categoria-card">
                    <h5 class="card-title">
                        <i class="bi bi-building"></i> Obras
                    </h5>
                    <button class="btn" data-bs-toggle="modal" data-bs-target="#modalObras">Ver</button>
                </div>
            </div>

            <!-- Tarjeta Puntajes -->
            <div class="col-md-3">
                <div class="categoria-card">
                    <h5 class="card-title">
                        <i class="bi bi-bar-chart-fill"></i> Puntajes
                    </h5>
                    <button class="btn" data-bs-toggle="modal" data-bs-target="#modalPuntajes">Ver</button>
                </div>
            </div>

            <!-- Tarjeta Horas Capacitadas -->
            <div class="col-md-3">
                <div class="categoria-card">
                    <h5 class="card-title">
                        <i class="bi bi-clock-history"></i> Horas Capacitadas
                    </h5>
                    <button class="btn" data-bs-toggle="modal" data-bs-target="#modalHoras">Ver</button>
                </div>
            </div>
        </div>

        <!-- Modales -->
        @foreach (var categoria in categorias)
        {
            <!-- Modal Principal -->
            <div class="modal fade" id="@($"modal{categoria.Id}")" tabindex="-1" aria-labelledby="@($"modal{categoria.Id}Label")" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">@categoria.Id</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3 d-flex justify-content-end gap-2">
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="@($"#modalAgregar{categoria.Id}")">Agregar</button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="@($"tabla{categoria.Id}")">
                                    <thead class="table-secondary">
                                        <tr>
                                            @foreach (var campo in categoria.Campos)
                                            {
                                                <th>@campo</th>
                                            }
                                            <th>Archivo PDF</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Agregar -->
            <div class="modal fade" id="@($"modalAgregar{categoria.Id}")" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <form class="modal-content" id="@($"formAgregar{categoria.Id}")">
                        <div class="modal-header">
                            <h5 class="modal-title">Agregar @categoria.Id</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            @for (int i = 0; i < categoria.Campos.Length; i++)
                            {
                                <div class="mb-3">
                                    <label class="form-label">@categoria.Campos[i]</label>
                                    @if (i == 1)
                                    {
                                        <input type="date" class="form-control" required>
                                    }
                                    else
                                    {
                                        <input type="text" class="form-control" required>
                                    }
                                </div>
                            }
                            <div class="mb-3">
                                <label class="form-label">Subir PDF</label>
                                <input type="file" class="form-control" accept="application/pdf" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        }
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const categorias = [

            { id: 'Investigaciones', campos: ['Nombre Universidad', 'Fecha de Registro', 'Datos Informativos'] },
            { id: 'Obras', campos: ['Nombre de la Obra', 'Fecha de Postulacion', 'Descripción'] },
            { id: 'Puntajes', campos: ['Nombre del Evaluado', 'Fecha', 'Puntaje'] },
            { id: 'Horas', campos: ['Nombre del Participante', 'Fecha de Capacitación', 'Cantidad de Horas'] }
        ];

        categorias.forEach(cat => {
            const form = document.getElementById(`formAgregar${cat.id}`);
            const tablaBody = document.querySelector(`#tabla${cat.id} tbody`);

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const inputs = form.querySelectorAll("input[type='text'], input[type='date'], input[type='file']");

                let nuevaFila = document.createElement("tr");

                for (let i = 0; i < inputs.length - 1; i++) {
                    nuevaFila.innerHTML += `<td>${inputs[i].value}</td>`;
                }

                const archivo = inputs[inputs.length - 1].files[0];
                if (archivo && archivo.type === "application/pdf") {
                    nuevaFila.innerHTML += `<td><a href="#" onclick="alert('PDF de prueba')">Ver PDF</a></td>`;
                } else {
                    alert("Sube un archivo PDF válido.");
                    return;
                }

                nuevaFila.innerHTML += `
                    <td>
                        <button class="btn btn-sm btn-warning me-2 btn-editar">Editar</button>
                        <button class="btn btn-sm btn-danger btn-eliminar">Eliminar</button>
                    </td>
                `;

                tablaBody.appendChild(nuevaFila);

                bootstrap.Modal.getInstance(document.getElementById(`modalAgregar${cat.id}`)).hide();
                form.reset();
            });

            // Delegación de eventos para Editar y Eliminar
            tablaBody.addEventListener("click", function (e) {
                const target = e.target;
                const fila = target.closest("tr");

                if (target.classList.contains("btn-eliminar")) {
                    if (confirm("¿Deseas eliminar esta fila?")) {
                        fila.remove();
                    }
                }

                if (target.classList.contains("btn-editar")) {
                    const celdas = fila.querySelectorAll("td");
                    const valores = Array.from(celdas).slice(0, cat.campos.length).map(td => td.textContent);

                    const modalId = `modalEditar${cat.id}`;
                    if (!document.getElementById(modalId)) {
                        crearModalEdicion(cat, modalId);
                    }

                    const modal = new bootstrap.Modal(document.getElementById(modalId));
                    modal.show();

                    const inputEditar = document.querySelectorAll(`#${modalId} input`);
                    valores.forEach((val, i) => inputEditar[i].value = val);

                    const formEditar = document.getElementById(`formEditar${cat.id}`);
                    formEditar.onsubmit = function (ev) {
                        ev.preventDefault();
                        inputEditar.forEach((inp, i) => celdas[i].textContent = inp.value);
                        modal.hide();
                    };
                }
            });
        });

        function crearModalEdicion(cat, modalId) {
            const div = document.createElement("div");
            div.innerHTML = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog">
                        <form class="modal-content" id="formEditar${cat.id}">
                            <div class="modal-header">
                                <h5 class="modal-title">Editar ${cat.id}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${cat.campos.map((c, i) => `
                                    <div class="mb-3">
                                        <label class="form-label">${c}</label>
                                        ${i === 1 ? `<input type="date" class="form-control" required>` :
                                            `<input type="text" class="form-control" required>`}
                                    </div>
                                `).join("")}
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Guardar cambios</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(div.firstElementChild);
        }
    </script>
</body>
</html>

@code {
    private class Categoria
    {
        public string Id { get; set; }
        public string[] Campos { get; set; }
    }

    private Categoria[] categorias = new[]
    {
        new Categoria { Id = "Investigaciones", Campos = new[] { "Nombre Universidad", "Fecha de Registro", "Datos Informativos" } },
        new Categoria { Id = "Obras", Campos = new[] { "Nombre de la Obra", "Fecha de Postulacion", "Descripción" } },
        new Categoria { Id = "Puntajes", Campos = new[] { "Nombre del Evaluado", "Fecha", "Puntaje" } },
        new Categoria { Id = "Horas", Campos = new[] { "Nombre del Participante", "Fecha de Capacitación", "Cantidad de Horas" } }
    };
}